#!/bin/bash

# XXX 2021-08-27: work-in-progress

command -v amixer > /dev/null || { echo "Missing dependency: amixer"; exit 1; }
command -v panel_theme > /dev/null || { echo "Missing dependency: panel_theme"; exit 1; }

. panel_theme

fifo='/tmp/panel_vol.fifo'

_make_pipe()
{
    if [ -p "$fifo" ]
    then
        return 0
    else
        mkfifo "$fifo" 2> /dev/null
    fi
}

_status()
{
    label='V:'
    # Could not do this with just parameter expansions...
    status="$(amixer get Master | awk -F'[][]' '/%/{print $2","$4;exit}')"
    output="${status%,*}"

    case "${status#*%}" in
        'off') echo "%{F$fg_alt}${label}%{F-} $output (Muted)" ;;
        *)     echo "%{F$fg_alt}${label}%{F-} $output"         ;;
    esac
}

_set()
{
    amixer set Master "$1"
}

_update()
{
    _make_pipe
    _status > "$fifo"
}

# Returns the state of volume.
_subscribe()
{
    _make_pipe
    tail -f "$fifo"
}

case "$1" in
    -s) _set "$2" ;;
    -S) _subscribe ;;
    -v) _status ;;
    *) _update ;;
esac
