# Configuration file for Neomutt.  Tested on 2019-02-28.  Debian Buster
# running NeoMutt 20180716.
#
# This configuration file obfuscates all private information that is
# necessary in the "Mailboxes" section (also see the key bindings for
# mailbox switching).  To adapt it to your system you need to make
# manual interventions.  Read this entry on the Arch Linux wiki:
# https://wiki.archlinux.org/index.php/Neomutt.  For the meaning of each
# setting, run `man neomuttrc`.
#
# This file and everything sourced herein is part of my dotfiles.  See
# https://gitlab.com/protesilaos/dotfiles.

# General settings
# ----------------
set arrow_cursor=no # yes == indicator "->" will note the position in the index, else the whole line is highlighted
set sleep_time=0

# Mailcap
auto_view text/html
alternative_order text/plain text/html
set mailcap_path=~/.config/neomutt/mailcap
set mailcap_sanitize=yes

# Colours
source "~/.config/neomutt/themes/tempus_theme_dark"

# Receiving
set mail_check=600
unset imap_check_subscribed
set imap_keepalive=300
unset imap_passive

# Cache
set header_cache='~/.config/neomutt/cache/headercache'
set message_cachedir='~/.config/neomutt/cache/messagecache'
set certificate_file='~/.config/neomutt/cache/certificates'

# Messages
set beep_new=yes
set delete=yes
set confirmappend=no
set confirmcreate=yes
unset markers # do not show markers for wrapped lines
set pager_index_lines=10
set mime_forward=yes # send forwarded mails as attachments

# Composing
# ---------
set editor="vim +':set textwidth=72' +':set formatoptions=twan12'"
set empty_subject='Your email'
set askcc=no
# # No need for spell check, as it is provided by Vim
# set ispell="aspell -e -c"
set edit_headers=no
set signature="~/.config/neomutt/mails/signature"

# Replies
set fast_reply=yes
set include=no
set reverse_name

# GPG
source ~/.config/neomutt/gpg.rc
set crypt_use_gpgme=yes
set crypt_autopgp=yes
set crypt_autosign=no
set crypt_autoencrypt=no
set crypt_autosmime=yes
set crypt_replyencrypt=yes
set crypt_replysignencrypted=yes
set pgp_timeout=3600

# Forgotten attachment feature
set abort_noattach=ask-yes

# Search for the following key words in the body of the email.  Covers
# English, French, Greek.
set abort_noattach_regex="\\<attach|attached|attachment|attachments\
|attaché|attachés|attache|attachons|joint|jointe|joints|jointes|joins\
|joignons|επισύναψη|επισυνάπτω|συνημμένο|συνημμένα|επισυναψη\
|επισυναπτω|συνημμενο|συνημμενα)\\>"

# Index and status bars
# ---------------------
# For the date_format, see `man strftime`.  For the index_format see
# `man neomuttrc`.  Notice the number in %C (index_fromat).
set date_format="%Y-%m-%d %R"
set index_format="%Z %-20.19F %s%*  %d"

## NOTE uncomment to sort by thread
#set sort=threads
#set sort_aux=reverse-last-date-received
set sort=reverse-date # newest at the top
set strict_threads="yes"
set sort_browser=alpha

# NOTE status bar colours are defined in the theme, which is sourced at
# the start of this file.  All dash characters are Unicode code point
# U+2500.  See https://en.wikipedia.org/wiki/Box-drawing_character.
set status_format='───%v: %f───(%P)───%>─\
[Msgs:%?M?%M/?%m%?n? New:%n?%?o? Del:%d?%?F? \
Flag:%F?%?t? Tag:%t?%?p? Post:%p?%?b? Inc:%b?%?l??]───'

set pager_format='───%F: %s%*─(%P)'

# Mailboxes
# ---------
# NOTE the passwords for each account are stored in an encrypted file.
# Each password is defined as a custom variable by prepending the `my_`
# directive.  Such as `set my_variable = "password"`.
#
# This setup may be in need of review, as it was established some time
# ago, before NeoMutt had gained traction.

# First retrieve passwords from secure file
source "gpg -dq $HOME/.config/neomutt/mails/passwords.gpg |"

source "~/.config/neomutt/mails/email-one"
folder-hook $folder 'source ~/.config/neomutt/mails/email-one'

source "~/.config/neomutt/mails/email-two"
folder-hook $folder 'source ~/.config/neomutt/mails/email-two'

source "~/.config/neomutt/mails/email-three"
folder-hook $folder 'source ~/.config/neomutt/mails/email-three'

# Sidebar settings (I don't really use this)
# ------------------------------------------
set sidebar_visible=no
set mail_check_stats
set sidebar_format="%B%?F? [%F]?%* %?N?%N/?%S"
set sidebar_short_path=yes
set sidebar_delim_chars='/'

# Key bindings
# ------------
bind editor <Tab> complete-query

# Compose a new email (not a reply) to the sender
bind index,pager @ compose-to-sender

# Vi Key Bindings
# modified from source: https://github.com/neomutt/neomutt/blob/master/contrib/vim-keys/vim-keys.rc

# Moving around
bind attach,browser,index       g   noop
bind attach,browser,index       gg  first-entry
bind attach,browser,index       G   last-entry
bind pager                      g   noop
bind pager                      gg  top
bind pager                      G   bottom
bind pager                      k   previous-line
bind pager                      j   next-line

# Scrolling
bind attach,browser,pager,index \CF next-page
bind attach,browser,pager,index \CB previous-page
bind attach,browser,pager,index \Cu half-up
bind attach,browser,pager,index \Cd half-down
bind browser,pager              \Ce next-line
bind browser,pager              \Cy previous-line
bind index                      \Ce next-line
bind index                      \Cy previous-line

# Moving messages
bind index D delete-message
bind index P purge-message # skip trash, remove permanently
bind index U undelete-message # also works as unpurge
bind index,pager F flag-message # "star" message
bind index,pager S save-message # TODO save where? Is this for archiving?
bind index,pager R group-reply

# Move message(s) to Archive
macro index A "<tag-prefix><enter-command>unset resolve<enter><tag-prefix><clear-flag>N<tag-prefix><enter-command>set resolve<enter><tag-prefix><save-message>=Archive<enter>" "Archive message"
macro pager A "<save-message>=Archive<enter>" "Archive message"

# Account switching
macro index,pager ,1 '<sync-mailbox><enter-command>source ~/.config/neomutt/mails/email-one<enter><change-folder>!<enter>'
macro index,pager ,2 '<sync-mailbox><enter-command>source ~/.config/neomutt/mails/email-two<enter><change-folder>!<enter>'
macro index,pager ,3 '<sync-mailbox><enter-command>source ~/.config/neomutt/mails/email-three<enter><change-folder>!<enter>'

# Sidebar
bind index,pager <left> sidebar-toggle-visible
bind index,pager <up> sidebar-prev
bind index,pager <down> sidebar-next
bind index,pager <right> sidebar-open
